{% extends "base.html" %}

{% block title %}
Run build
{% endblock title %}

{% block headline %}
Run build
{% endblock headline %}

{% block content %}

{% raw %}

<div id="app">

    <div class="grid">

        <div class="card shadow full">
            <div class="card-header py-3 text-white bg-primary">
                <h6 class="m-0 font-weight-bold">Select configuration(s)</h6>
            </div>
            <div class="card-body">

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; align-items: center;">

                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px;">Server configuration</label>
                        
                        <div style="display: flex; gap: 8px; align-items: flex-end;">
                            <select v-model="selectedTemplatePkg" class="template-select" style="flex-grow: 1;">
                                <option v-for="conf in sortedCustomConfigs" :key="conf.id" :value="conf">
                                    Open Site Energy - {{ conf.name }}
                                </option>
                                <option v-for="conf in sortedLocalConfigs" :key="conf.id" :value="conf.id">
                                    Local configuration - {{ conf.title }}
                                </option>
                            </select>
                            <button 
                                class="btn btn-primary" 
                                @click="addServerConfiguration"
                                style="white-space: nowrap;"
                            >
                                Add
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px;">Configuration URL</label>
                        
                        <div style="display: flex; gap: 8px; align-items: flex-end;">
                            <input 
                                v-model="configurationUrl" 
                                placeholder="https://" 
                                class="form-control" 
                                style="flex-grow: 1;"
                            >
                            <button 
                                class="btn btn-primary" 
                                @click="addURLConfiguration"
                                style="white-space: nowrap;"
                            >
                                Add
                            </button>
                        </div>
                    </div>

                    <div style="grid-column: span 2;">
                        <div v-for="(conf, index) in configurations" :key="index" 
                            :class="['badge', getBadgeClass(conf.type), 'border-0 p-1 mr-2 mb-2 shadow-sm d-inline-flex align-items-center rounded-pill']">
                            
                            <div class="text-left px-2">
                                <div class="text-white" style="font-size: 0.8rem; font-weight: 500;">
                                    {{ conf.name }}
                                </div>
                            </div>

                            <button type="button" class="close ml-2 text-white" @click="configurations.splice(index, 1)" style="outline: none; text-shadow: none; opacity: 0.8;">
                                <span aria-hidden="true"><i class="fa fa-times-circle" aria-hidden="true"></i></span>
                            </button>
                        </div>
                    </div>

                </div>

            </div>

        </div>


        <div class="card shadow mb-4">
            <div class="card-header py-3 text-white bg-primary">
                <h6 class="m-0 font-weight-bold">Global clipping area</h6>
            </div>
            <div class="card-body">
                <div>
<div class="form-group position-relative" id="clipping-search-app">
    <label>Enter clipping Area</label>
    
    <input 
        type="text" 
        v-model="searchQuery" 
        class="form-control" 
        placeholder="Type to filter areas..."
        @focus="showPopup = true"
    >

    <div v-if="showPopup && filteredAreas.length > 0" 
         class="shadow-lg border rounded position-absolute bg-white w-100" 
         style="z-index: 1000; max-height: 200px; overflow-y: auto; top: 100%;">
        
        <ul class="list-group list-group-flush">
            <li v-for="area in filteredAreas" 
                :key="area"
                @click="selectArea(area)"
                class="list-group-item list-group-item-action cursor-pointer"
                style="cursor: pointer;">
                {{ area }}
            </li>
        </ul>
    </div>

    <input type="hidden" name="clipping_area" :value="selectedArea">
</div>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="button-commandline-copy"></div>

<script>

{% endraw %}

const rawClippingAreas = {{ clippingareas | tojson }};

console.log(rawClippingAreas);

{% raw %}

const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

createApp({
    setup() {
        const ckanUrl = ref("https://ckan.openwind.energy");
        const backendBase = '';
        const proxyUrl = backendBase + "ckan";
        const OPEN_SITE_ENERGY_YML = 'Open Site Energy YML';
        const defaultAreas = "england,wales,scotland,northern-ireland,uk";
        const lastSyncedUrl = ref(""); // Tracks the last successful fetch
        const library = ref({});
        const customConfigs = ref([]);
        const localConfigs = ref([]);
        const configurationUrl = ref("");
        const selectedTemplatePkg = ref("new");
        const isInitialLoading = ref(false);
        const configurations = ref([]);
        const allAreas = ref(rawClippingAreas);
        const searchQuery = ref('');
        const showPopup = ref(false);

        const filteredAreas = computed(() => {
            const query = searchQuery.value.toLowerCase();
            return allAreas.value.filter(area => 
                area.toLowerCase().startsWith(query)
            );
        });

        const selectArea = (area) => {
            searchQuery.value = area;
            showPopup.value = false;
            // Add any extra logic for when an area is chosen
        };

        const getBadgeClass = (type) => {
            const map = {
                'server': 'badge-primary',
                'local': 'badge-success',
                'url': 'badge-info'
            };
            return map[type] || 'badge-secondary';
        };

        const currentConfigurationTitle = computed(() => {
            const val = selectedTemplatePkg.value;
            if (val.title) return val.title;
            const idToFind = typeof val === 'string' ? val : val.id;
            const match = localConfigs.value.find(c => c.id === idToFind);
            
            return match ? match.title : idToFind;
        });

        // Sorted Backend Configs (by name)
        const sortedCustomConfigs = computed(() => {
        return [...customConfigs.value].sort((a, b) => 
            a.name.localeCompare(b.name)
        );
        });

        // Sorted Local Templates (by title)
        const sortedLocalConfigs = computed(() => {
        return [...localConfigs.value].sort((a, b) => 
            a.title.localeCompare(b.title)
        );
        });

        // Fetch custom list from backend
        const refreshCustomConfigs = async () => {
            const response = await fetch(backendBase + 'list');
            const data = await response.json();
            localConfigs.value = data; 
        };

        const fetchLibrary = async () => {
            isInitialLoading.value = true;
            const currentAttemptUrl = ckanUrl.value;
            const baseUrl = currentAttemptUrl.replace(/\/+$/, "");
            const api = `${baseUrl}/api/3/action/package_search?rows=1000`;
            
            try {
                const res = await fetch(`${proxyUrl}?url=${encodeURIComponent(api)}`);
                if (!res.ok) throw new Error(`Proxy returned ${res.status}`);
                const data = await res.json();
                
                if (data.success && data.result && data.result.results) {
                    const results = {};
                    const configs = [];

                    data.result.results.forEach(pkg => {
                        const group = (pkg.groups && pkg.groups.length > 0) ? pkg.groups[0] : { name: 'default', title: 'Default' };
                        
                        if (group.name.includes('custom') || group.title === 'Custom configurations') {
                            if (pkg.resources && pkg.resources.some(r => r.format === OPEN_SITE_ENERGY_YML)) {
                                configs.push(pkg);
                            }
                        } else {
                            if (!results[group.name]) results[group.name] = { group_title: group.title, prefixes: {} };
                            const prefix = pkg.name.split('--')[0];
                           if (!results[group.name].prefixes[prefix]) {
                                const parts = (pkg.title || pkg.name).split(' - ');
                                results[group.name].prefixes[prefix] = {
                                    prefix: prefix,
                                    cleanTitle: parts.length > 1 ? parts.slice(0, -1).join(' - ') : parts[0],
                                    children: [],
                                    childTitles: [] // New: This stores the "National Parks - England" strings
                                };
                            }
                            results[group.name].prefixes[prefix].children.push(pkg.name);
                            results[group.name].prefixes[prefix].childTitles.push(pkg.title || pkg.name);
                        }
                    });

                    library.value = results;
                    customConfigs.value = configs.sort((a,b) => (a.title || a.name).localeCompare(b.title || b.name));
                    lastSyncedUrl.value = currentAttemptUrl; // Success! Update the tracking ref
                }
            } catch (e) {
                console.error("Connection error:", e);
                alert("Failed to sync library: " + e.message);
            } finally {
                isInitialLoading.value = false;
            }
        };

        const addServerConfiguration = async () => {
            const selected = selectedTemplatePkg.value;
            if (!selected) return;

            let type, value, name;

            if (typeof selected === 'object' && selected.id) {
                // Source: sortedCustomConfigs
                type = 'server';
                value = selected.id;
                name = selected.name; // From conf.name
            } else {
                // Source: sortedLocalConfigs (where value is just the ID)
                type = 'local';
                value = selected;
                const localObj = sortedLocalConfigs.value.find(l => l.id === selected);
                name = localObj ? localObj.title : value;
            }

            // 2. Intelligent Duplication Check
            const isDuplicate = configurations.value.some(conf => 
                conf.type === type && conf.value === value
            );

            if (!isDuplicate) {
                configurations.value.push({ 
                    type, 
                    value, 
                    name: `Open Site Energy - ${name}` 
                });
            }
            
            selectedTemplatePkg.value = null;
        };

        const addURLConfiguration = async () => {
            const url = configurationUrl.value.trim();

            if (url.startsWith('https://')) {
                const isDuplicate = configurations.value.some(conf => 
                    conf.type === 'url' && conf.value === url
                );

                if (!isDuplicate) {
                    configurations.value.push({ 
                        type: 'url', 
                        value: url, 
                        name: url // For URLs, the name is usually the URL itself
                    });
                    configurationUrl.value = '';
                }
            }
        };

        const loadBuildData = async () => {
            try {
                const response = await fetch('/getbuild');
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                configurations.value = data.configurations || [];
            } catch (error) {
                console.error("Error loading build:", error);
            }
        };

        const saveBuildData = async () => {
            try {
                const response = await fetch('/savebuild', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        configurations: configurations.value
                    })
                });

                if (response.ok) {
                    // console.log("Save successful");
                }
            } catch (error) {
                console.error("Error saving build:", error);
            }
        };

        watch(configurations, (newVal, oldVal) => {
            saveBuildData();
        }, { deep: true });

        onMounted(() => {
            fetchLibrary();
            refreshCustomConfigs();
            loadBuildData();
        });

        return { 
            ckanUrl, 
            library, 
            customConfigs, 
            localConfigs,
            selectedTemplatePkg, 
            configurations,
            isInitialLoading,
            addServerConfiguration,
            addURLConfiguration,
            configurationUrl,
            fetchLibrary, 
            sortedCustomConfigs,
            sortedLocalConfigs,
            currentConfigurationTitle,
            getBadgeClass,
            searchQuery,
            showPopup,
            filteredAreas,
            selectArea
       };
    }
}).mount('#app');
</script>

<!-- <form action="/processingstart" method="POST" enctype="application/x-www-form-urlencoded" class="d-sm-inline-block form-inline mr-auto my-2 my-md-0 mw-100">

    <div class="row">

        <div class="col-lg-6">
            

            <div class="card shadow mb-4">
                <div class="card-header py-3 text-white bg-primary">
                    <h6 class="m-0 font-weight-bold">Custom configuration file</h6>
                </div>
                <div class="card-body">
                    <p class="m-0 mb-2 text-secondary">Enter full URL of <a target="_new" href="https://github.com/open-wind/opensiteenergy/?tab=readme-ov-file#custom-configuration-and-custom-clipping"><b>YML custom configuration file</b></a>. Leave blank if no custom configuration required.</p>

                    <div>
                        <div class="input-group">
                            <input size="60" name="custom-configuration" type="text" class="form-control bg-light border-0 small"
                                aria-label="Search" placeholder="https://your.domain/custom.yml" spellcheck="false" autocorrect="off" autocomplete="off" aria-describedby="basic-addon2">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-danger text-white">
                    <h6 class="m-0 font-weight-bold">Purge existing data</h6>
                </div>
                <div class="card-body">
                    <p class="m-0 mb-2 text-secondary">Click checkbox below to delete existing dataset downloads and database tables and rebuild layers from scratch.</p>
                    <p> <i>Note: this may considerably increase time to generate final layers.</i></p>

                    <div>
                        <div class="input-group">
                            <div class="input-group-prepend">
                            <div class="input-group-text fs-4">
                                <input id="purge-all" name="purge-all" type="checkbox" aria-label="Purge existing data">
                            </div>
                            </div>
                            <label class="form-check-label form-control" for="purge-all">
                                <b>Purge existing downloads and database tables</b>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-lg-6">
            <button class="btn btn-success btn-lg btn-icon-split" type="submit">
                <span class="icon text-white-50">
                    <i class="fa fa-play-circle"></i>
                </span>
                <span class="text">Start generating constraint layers</span>
            </button>
        </div>
    </div>

</form> -->

{% endraw %}

{% endblock content %}

